# æ€§èƒ½ä¼˜åŒ–è¯´æ˜æ–‡æ¡£

## ğŸ“Œ å…³äº `await` çš„é‡è¦è¯´æ˜

### ä»€ä¹ˆæ˜¯ `await`ï¼Ÿ

`await` æ˜¯ Python **å¼‚æ­¥ç¼–ç¨‹**çš„å…³é”®å­—ï¼Œç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚å®ƒçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ï¼š

```python
# å¼‚æ­¥å‡½æ•°ç¤ºä¾‹
async def fetch_data():
    # await ä¼šæš‚åœå½“å‰å‡½æ•°ï¼Œè®©å‡ºæ§åˆ¶æƒ
    # åœ¨ç­‰å¾…æœŸé—´ï¼Œç¨‹åºå¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡
    result = await some_async_operation()
    return result
```

### `await` çš„ä¸‰ä¸ªå…³é”®ç‰¹æ€§

1. **å¿…é¡»åœ¨ `async` å‡½æ•°ä¸­ä½¿ç”¨**
   ```python
   # âœ… æ­£ç¡®
   async def my_function():
       result = await async_operation()

   # âŒ é”™è¯¯
   def my_function():
       result = await async_operation()  # è¯­æ³•é”™è¯¯ï¼
   ```

2. **åªèƒ½ç­‰å¾…å¯ç­‰å¾…å¯¹è±¡ï¼ˆawaitableï¼‰**
   - åç¨‹ï¼ˆcoroutineï¼‰
   - Task
   - Future
   - å®ç°äº† `__await__` æ–¹æ³•çš„å¯¹è±¡

3. **éœ€è¦æ•´ä¸ªè°ƒç”¨é“¾æ”¯æŒå¼‚æ­¥**
   ```python
   # å¦‚æœåº•å±‚åº“ä¸æ”¯æŒå¼‚æ­¥ï¼Œawait æ— æ³•ä½¿ç”¨
   # ä¾‹å¦‚ï¼šsentence-transformers æ˜¯åŒæ­¥åº“
   embedding = model.encode(text)  # åŒæ­¥è°ƒç”¨
   # ä¸èƒ½å†™æˆï¼š
   # embedding = await model.encode(text)  # é”™è¯¯ï¼
   ```

## âš ï¸ ä¸ºä»€ä¹ˆä½ çš„ä»£ç ä¸èƒ½ç›´æ¥ä½¿ç”¨ `await`ï¼Ÿ

### å½“å‰ä»£ç çš„é™åˆ¶

ä½ çš„é¡¹ç›®ä½¿ç”¨çš„åº“**å¤§å¤šä¸æ”¯æŒå¼‚æ­¥**ï¼š

| åº“ | æ˜¯å¦æ”¯æŒå¼‚æ­¥ | è¯´æ˜ |
|---|---|---|
| **PyAutoGen** | âŒ éƒ¨åˆ†æ”¯æŒ | ä¸»è¦APIæ˜¯åŒæ­¥çš„ |
| **sentence-transformers** | âŒ ä¸æ”¯æŒ | çº¯åŒæ­¥åº“ |
| **ChromaDB** | âš ï¸ æœ‰é™æ”¯æŒ | ä½ ä½¿ç”¨çš„æ˜¯åŒæ­¥å®¢æˆ·ç«¯ |
| **matplotlib** | âŒ ä¸æ”¯æŒ | çº¯åŒæ­¥åº“ |

### é”™è¯¯ç¤ºä¾‹

```python
# âŒ è¿™æ ·å†™æ˜¯é”™è¯¯çš„ï¼
async def add_document(self, doc_path: str):
    # sentence-transformers ä¸æ”¯æŒå¼‚æ­¥
    embedding = await self.embedding_model.encode(paragraph)  # è¯­æ³•é”™è¯¯ï¼

    # ChromaDB åŒæ­¥å®¢æˆ·ç«¯ä¸æ”¯æŒå¼‚æ­¥
    await self.collection.add(...)  # è¯­æ³•é”™è¯¯ï¼
```

## âœ… å®é™…å¯è¡Œçš„ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ‰¹é‡å¤„ç†ï¼ˆæ¨èï¼Œå·²å®ç°ï¼‰

**åŸç†**ï¼šå‡å°‘å‡½æ•°è°ƒç”¨æ¬¡æ•°å’ŒI/Oæ“ä½œæ¬¡æ•°

**ä¼˜åŒ–å‰**ï¼ˆé€ä¸ªå¤„ç†ï¼‰ï¼š
```python
# å¤„ç†10ä¸ªæ®µè½éœ€è¦è°ƒç”¨10æ¬¡
for paragraph in paragraphs:
    embedding = model.encode(paragraph)  # è°ƒç”¨10æ¬¡
    collection.add(...)                   # æ’å…¥10æ¬¡
```

**ä¼˜åŒ–å**ï¼ˆæ‰¹é‡å¤„ç†ï¼‰ï¼š
```python
# å¤„ç†10ä¸ªæ®µè½åªéœ€è°ƒç”¨1æ¬¡
embeddings = model.encode(paragraphs)  # åªè°ƒç”¨1æ¬¡ï¼
collection.add(                         # åªæ’å…¥1æ¬¡ï¼
    ids=ids,
    embeddings=embeddings,
    documents=paragraphs
)
```

**æ€§èƒ½æå‡**ï¼š3-5å€

**ä¸ºä»€ä¹ˆæ›´å¿«ï¼Ÿ**
1. **å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€**ï¼šæ¨¡å‹åˆå§‹åŒ–ã€æ•°æ®ä¼ è¾“ç­‰å›ºå®šå¼€é”€åªéœ€ä¸€æ¬¡
2. **æ›´å¥½çš„GPUåˆ©ç”¨ç‡**ï¼šæ‰¹é‡å¤„ç†å¯ä»¥å¹¶è¡Œè®¡ç®—
3. **å‡å°‘æ•°æ®åº“I/O**ï¼šå‡å°‘ç½‘ç»œå¾€è¿”å’Œäº‹åŠ¡å¼€é”€

### æ–¹æ¡ˆ2ï¼šå¤šçº¿ç¨‹å¤„ç†ï¼ˆé€‚ç”¨äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼‰

è™½ç„¶ä¸èƒ½ç”¨ `await`ï¼Œä½†å¯ä»¥ç”¨å¤šçº¿ç¨‹ï¼š

```python
from concurrent.futures import ThreadPoolExecutor

def process_multiple_queries(questions):
    """å¹¶è¡Œå¤„ç†å¤šä¸ªæŸ¥è¯¢"""
    with ThreadPoolExecutor(max_workers=4) as executor:
        results = list(executor.map(rag_system.query, questions))
    return results
```

**é€‚ç”¨åœºæ™¯**ï¼š
- åŒæ—¶å¤„ç†å¤šä¸ªç‹¬ç«‹çš„æŸ¥è¯¢
- å¹¶è¡Œè¯»å–å¤šä¸ªæ–‡ä»¶
- å¹¶è¡Œè°ƒç”¨å¤šä¸ªAPI

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬çš„åº“ï¼ˆéœ€è¦é‡æ„ï¼‰

å¦‚æœè¦çœŸæ­£ä½¿ç”¨ `await`ï¼Œéœ€è¦ï¼š

1. **ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬çš„ChromaDB**
   ```python
   # éœ€è¦å®‰è£…å¼‚æ­¥å®¢æˆ·ç«¯
   from chromadb.async_client import AsyncClient

   async def query_async(question):
       client = await AsyncClient()
       results = await client.query(...)
   ```

2. **ä½¿ç”¨å¼‚æ­¥çš„EmbeddingæœåŠ¡**
   ```python
   # ä¾‹å¦‚ä½¿ç”¨OpenAIçš„å¼‚æ­¥API
   import openai

   async def get_embedding_async(text):
       response = await openai.Embedding.acreate(
           model="text-embedding-ada-002",
           input=text
       )
       return response['data'][0]['embedding']
   ```

3. **é‡æ„æ•´ä¸ªè°ƒç”¨é“¾**
   - æ‰€æœ‰å‡½æ•°éƒ½è¦æ”¹æˆ `async def`
   - æ‰€æœ‰è°ƒç”¨éƒ½è¦åŠ  `await`
   - éœ€è¦ä½¿ç”¨ `asyncio.run()` æˆ–äº‹ä»¶å¾ªç¯

**æˆæœ¬**ï¼šéœ€è¦å¤§é‡é‡æ„ï¼Œä¸æ¨è

## ğŸš€ å·²å®ç°çš„ä¼˜åŒ–

### ä¼˜åŒ–ç‰ˆ RAG ç³»ç»Ÿ

æ–‡ä»¶ï¼š`rag/rag_system_optimized.py`

**å…³é”®ä¼˜åŒ–ç‚¹**ï¼š

1. **æ‰¹é‡ç”Ÿæˆembeddings**
   ```python
   # ä¸€æ¬¡æ€§å¤„ç†32ä¸ªæ®µè½ï¼ˆå¯è°ƒæ•´ï¼‰
   embeddings = self.embedding_model.encode(
       batch_paragraphs,  # æ‰¹é‡è¾“å…¥
       show_progress_bar=False,
       convert_to_numpy=True
   )
   ```

2. **æ‰¹é‡æ’å…¥æ•°æ®åº“**
   ```python
   # ä¸€æ¬¡æ€§æ’å…¥å¤šæ¡è®°å½•
   self.collection.add(
       ids=ids,
       embeddings=embeddings_list,
       documents=batch_paragraphs,
       metadatas=metadatas
   )
   ```

### æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | åŸå§‹ç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ | æå‡ |
|---|---|---|---|
| å¤„ç†10ä¸ªæ®µè½ | ~2-3ç§’ | ~0.5-1ç§’ | **3-5å€** |
| å¤„ç†100ä¸ªæ®µè½ | ~20-30ç§’ | ~5-8ç§’ | **4-6å€** |
| æ•°æ®åº“æ’å…¥æ¬¡æ•° | 100æ¬¡ | 4æ¬¡ï¼ˆbatch_size=32ï¼‰ | **å‡å°‘96%** |

## ğŸ“ å¦‚ä½•ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬

### æ­¥éª¤1ï¼šæ›´æ–° `rag/__init__.py`

```python
from .rag_system_optimized import RAGSystemOptimized

__all__ = [
    'RAGSystem',
    'RAGSystemOptimized',  # æ–°å¢
    'init_rag_system',
    'get_rag_instance'
]
```

### æ­¥éª¤2ï¼šä¿®æ”¹ `rag/initializer.py`

```python
from .rag_system_optimized import RAGSystemOptimized  # æ”¹ç”¨ä¼˜åŒ–ç‰ˆæœ¬

def init_rag_system(knowledge_file: str = "qsh_profile.txt", force_reload: bool = True):
    global _rag_instance

    # ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬
    _rag_instance = RAGSystemOptimized()

    if force_reload:
        _rag_instance.clear_collection()

    # æ‰¹é‡å¤„ç†ï¼Œbatch_sizeå¯ä»¥æ ¹æ®å†…å­˜è°ƒæ•´
    _rag_instance.add_document(knowledge_file, batch_size=32)

    return _rag_instance
```

### æ­¥éª¤3ï¼šè¿è¡Œæµ‹è¯•

```bash
python main.py
```

ä½ ä¼šçœ‹åˆ°æ˜æ˜¾çš„é€Ÿåº¦æå‡ï¼

## ğŸ¯ æ€»ç»“

### âŒ ä¸èƒ½åšçš„äº‹

1. **ä¸èƒ½éšæ„æ·»åŠ  `await`**ï¼šåº•å±‚åº“ä¸æ”¯æŒ
2. **ä¸èƒ½æœŸæœ› `await` è‡ªåŠ¨åŠ é€Ÿ**ï¼šéœ€è¦æ•´ä¸ªè°ƒç”¨é“¾æ”¯æŒå¼‚æ­¥

### âœ… å¯ä»¥åšçš„äº‹

1. **æ‰¹é‡å¤„ç†**ï¼šå‡å°‘å‡½æ•°è°ƒç”¨å’ŒI/Oæ¬¡æ•°ï¼ˆå·²å®ç°ï¼‰
2. **å¤šçº¿ç¨‹**ï¼šå¤„ç†ç‹¬ç«‹çš„I/Oå¯†é›†å‹ä»»åŠ¡
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šé¿å…é‡å¤è®¡ç®—
4. **ç®—æ³•ä¼˜åŒ–**ï¼šé€‰æ‹©æ›´é«˜æ•ˆçš„ç®—æ³•

### ğŸš€ æ¨èæ–¹æ¡ˆ

**ä¼˜å…ˆä½¿ç”¨æ‰¹é‡å¤„ç†**ï¼ˆå·²å®ç°ï¼‰ï¼Œè¿™æ˜¯æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ–¹å¼ï¼Œæ— éœ€é‡æ„ä»£ç ï¼Œæ€§èƒ½æå‡3-5å€ã€‚

å¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- ä½¿ç”¨æ›´å¿«çš„Embeddingæ¨¡å‹
- å¢åŠ batch_sizeï¼ˆå¦‚æœå†…å­˜å…è®¸ï¼‰
- ä½¿ç”¨GPUåŠ é€Ÿï¼ˆå¦‚æœæœ‰GPUï¼‰

---

**ä½œè€…**: QSH
**æ›´æ–°æ—¶é—´**: 2026-02-10
